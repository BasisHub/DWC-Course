---
phase: 01-pre-flight
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
autonomous: true

must_haves:
  truths:
    - "A push to main that introduces a TypeScript error fails CI before the build step"
    - "A pull request to main runs typecheck and build without deploying"
    - "Pushes to main still deploy to GitHub Pages after passing typecheck and build"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "CI pipeline with typecheck gate and PR trigger"
      contains: "npm run typecheck"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "npm run typecheck"
      via: "CI step before build"
      pattern: "run: npm run typecheck"
    - from: ".github/workflows/deploy.yml"
      to: "deploy job"
      via: "conditional execution"
      pattern: "if:.*github.event_name.*push"
---

<objective>
Add TypeScript type checking to the CI pipeline and enable pull request validation. This covers requirement PRE-04.

Purpose: Catch type errors before they reach production. Currently, a TypeScript error could be pushed to main and deployed without any CI gate. Adding typecheck before build ensures type errors fail the pipeline immediately. Adding PR triggers ensures errors are caught before merge, not after.

Output: An updated GitHub Actions workflow that runs typecheck before build, triggers on both pushes to main and PRs to main, and only deploys on pushes to main.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-pre-flight/01-CONTEXT.md
@.planning/phases/01-pre-flight/01-RESEARCH.md
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add typecheck step to CI build job</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
  Add a "Type check" step to the build job in `.github/workflows/deploy.yml`, between the "Install dependencies" step and the "Build website" step:

  ```yaml
      - name: Type check
        run: npm run typecheck
  ```

  This must appear AFTER `npm ci` (dependencies needed for type checking) and BEFORE `npm run build` (fail fast on type errors before spending time on a full build).
  </action>
  <verify>
  Read the updated deploy.yml and confirm the step order is:
  1. Checkout
  2. Setup Node.js
  3. Install dependencies
  4. Type check     <-- NEW
  5. Build website
  6. Upload artifact

  Run `npm run typecheck` locally to confirm it still passes (sanity check that the command works).
  </verify>
  <done>
  The deploy.yml build job includes `npm run typecheck` before `npm run build`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pull request trigger with deploy guard</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
  Two changes to `.github/workflows/deploy.yml`:

  1. Add `pull_request` trigger to the `on:` block:
     ```yaml
     on:
       push:
         branches:
           - main
       pull_request:
         branches:
           - main
       workflow_dispatch:
     ```

  2. Add a condition to the `deploy` job so it only runs on pushes to main (not on PRs):
     ```yaml
     deploy:
       if: github.event_name == 'push' && github.ref == 'refs/heads/main'
       environment:
         name: github-pages
         url: ${{ steps.deployment.outputs.page_url }}
       runs-on: ubuntu-latest
       needs: build
       steps:
         - name: Deploy to GitHub Pages
           id: deployment
           uses: actions/deploy-pages@v4
     ```

  The `if` condition goes on the `deploy` job (NOT the build job). The build job must run on BOTH pushes and PRs so that typecheck and build are validated on PRs. Only the deploy step is gated to pushes.

  Do NOT change the `permissions`, `concurrency`, or `build` job sections (except for the typecheck step already added in Task 1).
  </action>
  <verify>
  Read the final deploy.yml and confirm:
  1. `on:` block includes both `push` and `pull_request` triggers for `main`
  2. `build` job has NO `if` condition (runs on all triggers)
  3. `deploy` job has `if: github.event_name == 'push' && github.ref == 'refs/heads/main'`
  4. All existing steps and configuration are preserved

  Validate YAML syntax: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"` (or `npx yaml-lint .github/workflows/deploy.yml` if available). If neither works, visual inspection of indentation is sufficient.
  </verify>
  <done>
  PRs to main trigger typecheck + build (no deploy). Pushes to main trigger typecheck + build + deploy. Type errors caught before merge.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `.github/workflows/deploy.yml` contains `run: npm run typecheck` before `run: npm run build`
2. The workflow triggers on both `push` and `pull_request` to `main`
3. The `deploy` job has an `if` condition preventing deployment on PRs
4. The YAML is syntactically valid
5. `npm run typecheck` passes locally (confirming the command works)
</verification>

<success_criteria>
- PRE-04: TypeScript type checking runs in CI before the build step
- PRs to main validate types and build without deploying
- Pushes to main continue to deploy after passing all checks
- No regression in existing deployment behavior
</success_criteria>

<output>
After completion, create `.planning/phases/01-pre-flight/01-02-SUMMARY.md`
</output>
